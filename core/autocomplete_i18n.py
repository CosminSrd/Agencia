import unicodedata
import re


def normalizar_texto(texto: str) -> str:
    if not texto:
        return ''
    normalizado = ''.join(
        c for c in unicodedata.normalize('NFKD', texto)
        if not unicodedata.combining(c)
    ).lower()
    normalizado = re.sub(r'[^a-z0-9\s]', ' ', normalizado)
    normalizado = re.sub(r'\s+', ' ', normalizado)
    return normalizado.strip()


SPANISH_TO_ENGLISH = {
    'afganistan': 'afghanistan',
    'albania': 'albania',
    'alemania': 'germany',
    'argelia': 'algeria',
    'andorra': 'andorra',
    'angola': 'angola',
    'antigua y barbuda': 'antigua and barbuda',
    'arabia saudi': 'saudi arabia',
    'arabia saudita': 'saudi arabia',
    'argentina': 'argentina',
    'armenia': 'armenia',
    'australia': 'australia',
    'austria': 'austria',
    'azerbaiyan': 'azerbaijan',
    'bahamas': 'bahamas',
    'barein': 'bahrain',
    'banglades': 'bangladesh',
    'barbados': 'barbados',
    'belarus': 'belarus',
    'belgica': 'belgium',
    'belice': 'belize',
    'benin': 'benin',
    'butan': 'bhutan',
    'bolivia': 'bolivia',
    'bosnia y herzegovina': 'bosnia and herzegovina',
    'botsuana': 'botswana',
    'brasil': 'brazil',
    'brunei': 'brunei',
    'bulgaria': 'bulgaria',
    'burkina faso': 'burkina faso',
    'burundi': 'burundi',
    'cabo verde': 'cape verde',
    'camboya': 'cambodia',
    'camerun': 'cameroon',
    'canada': 'canada',
    'catar': 'qatar',
    'chad': 'chad',
    'chile': 'chile',
    'china': 'china',
    'chipre': 'cyprus',
    'colombia': 'colombia',
    'comoras': 'comoros',
    'corea del norte': 'north korea',
    'corea del sur': 'south korea',
    'corea sur': 'south korea',
    'korea del sur': 'south korea',
    'costa de marfil': 'ivory coast',
    'costa rica': 'costa rica',
    'croacia': 'croatia',
    'cuba': 'cuba',
    'dinamarca': 'denmark',
    'dominica': 'dominica',
    'ecuador': 'ecuador',
    'egipto': 'egypt',
    'el salvador': 'el salvador',
    'emiratos arabes': 'united arab emirates',
    'emiratos arabes unidos': 'united arab emirates',
    'eau': 'united arab emirates',
    'uae': 'united arab emirates',
    'eritrea': 'eritrea',
    'eslovaquia': 'slovakia',
    'eslovenia': 'slovenia',
    'espana': 'spain',
    'estados unidos': 'united states',
    'estados unidos de america': 'united states',
    'eeuu': 'united states',
    'ee uu': 'united states',
    'usa': 'united states',
    'us': 'united states',
    'estonia': 'estonia',
    'esuatini': 'eswatini',
    'etiopia': 'ethiopia',
    'filipinas': 'philippines',
    'finlandia': 'finland',
    'fiyi': 'fiji',
    'francia': 'france',
    'fr': 'france',
    'gabon': 'gabon',
    'gambia': 'gambia',
    'georgia': 'georgia',
    'ghana': 'ghana',
    'granada': 'grenada',
    'grecia': 'greece',
    'guatemala': 'guatemala',
    'guinea': 'guinea',
    'guinea ecuatorial': 'equatorial guinea',
    'guinea bisau': 'guinea-bissau',
    'guyana': 'guyana',
    'haiti': 'haiti',
    'honduras': 'honduras',
    'hungria': 'hungary',
    'india': 'india',
    'indonesia': 'indonesia',
    'iran': 'iran',
    'irak': 'iraq',
    'irlanda': 'ireland',
    'islandia': 'iceland',
    'islas marshall': 'marshall islands',
    'islas salomon': 'solomon islands',
    'israel': 'israel',
    'italia': 'italy',
    'jamaica': 'jamaica',
    'japon': 'japan',
    'jordania': 'jordan',
    'kazajistan': 'kazakhstan',
    'kenia': 'kenya',
    'kirguistan': 'kyrgyzstan',
    'kiribati': 'kiribati',
    'kuwait': 'kuwait',
    'laos': 'laos',
    'lesoto': 'lesotho',
    'letonia': 'latvia',
    'libano': 'lebanon',
    'liberia': 'liberia',
    'libia': 'libya',
    'liechtenstein': 'liechtenstein',
    'lituania': 'lithuania',
    'luxemburgo': 'luxembourg',
    'macedonia del norte': 'north macedonia',
    'madagascar': 'madagascar',
    'malasia': 'malaysia',
    'malaui': 'malawi',
    'maldivas': 'maldives',
    'mali': 'mali',
    'malta': 'malta',
    'marruecos': 'morocco',
    'mauricio': 'mauritius',
    'mauritania': 'mauritania',
    'mexico': 'mexico',
    'micronesia': 'micronesia',
    'moldavia': 'moldova',
    'monaco': 'monaco',
    'mongolia': 'mongolia',
    'montenegro': 'montenegro',
    'mozambique': 'mozambique',
    'myanmar': 'myanmar',
    'namibia': 'namibia',
    'nauru': 'nauru',
    'nepal': 'nepal',
    'nicaragua': 'nicaragua',
    'niger': 'niger',
    'nigeria': 'nigeria',
    'noruega': 'norway',
    'nueva zelanda': 'new zealand',
    'oman': 'oman',
    'paises bajos': 'netherlands',
    'holanda': 'netherlands',
    'pakistan': 'pakistan',
    'palaos': 'palau',
    'panama': 'panama',
    'papua nueva guinea': 'papua new guinea',
    'paraguay': 'paraguay',
    'peru': 'peru',
    'polonia': 'poland',
    'portugal': 'portugal',
    'reino unido': 'united kingdom',
    'r unido': 'united kingdom',
    'uk': 'united kingdom',
    'u k': 'united kingdom',
    'gran bretana': 'great britain',
    'gran bretaÃ±a': 'great britain',
    'britanico': 'british',
    'inglaterra': 'england',
    'escocia': 'scotland',
    'gales': 'wales',
    'republica checa': 'czech republic',
    'rep checa': 'czech republic',
    'r checa': 'czech republic',
    'chequia': 'czech republic',
    'republica democratica del congo': 'democratic republic of the congo',
    'republica del congo': 'republic of the congo',
    'republica dominicana': 'dominican republic',
    'ruanda': 'rwanda',
    'rumania': 'romania',
    'rusia': 'russia',
    'samoa': 'samoa',
    'san cristobal y nieves': 'saint kitts and nevis',
    'san marino': 'san marino',
    'san vicente y las granadinas': 'saint vincent and the grenadines',
    'santa lucia': 'saint lucia',
    'santo tome y principe': 'sao tome and principe',
    'sao tome y principe': 'sao tome and principe',
    'senegal': 'senegal',
    'serbia': 'serbia',
    'seychelles': 'seychelles',
    'sierra leona': 'sierra leone',
    'singapur': 'singapore',
    'siria': 'syria',
    'somalia': 'somalia',
    'sri lanka': 'sri lanka',
    'sudafrica': 'south africa',
    'sudan': 'sudan',
    'sudan del sur': 'south sudan',
    'suecia': 'sweden',
    'suiza': 'switzerland',
    'surinam': 'suriname',
    'tailandia': 'thailand',
    'taiwan': 'taiwan',
    'tanzania': 'tanzania',
    'tayikistan': 'tajikistan',
    'timor oriental': 'timor-leste',
    'togo': 'togo',
    'tonga': 'tonga',
    'trinidad y tobago': 'trinidad and tobago',
    'tunez': 'tunisia',
    'turkmenistan': 'turkmenistan',
    'turquia': 'turkey',
    'tuvalu': 'tuvalu',
    'ucrania': 'ukraine',
    'uganda': 'uganda',
    'uruguay': 'uruguay',
    'uzbekistan': 'uzbekistan',
    'vanuatu': 'vanuatu',
    'vaticano': 'vatican city',
    'venezuela': 'venezuela',
    'vietnam': 'vietnam',
    'yemen': 'yemen',
    'yibuti': 'djibouti',
    'zambia': 'zambia',
    'zimbabue': 'zimbabwe',
    'bucarest': 'bucharest',
    'londres': 'london',
    'nueva york': 'new york',
    'moscu': 'moscow',
    'estambul': 'istanbul',
    'atenas': 'athens',
    'praga': 'prague',
    'viena': 'vienna',
    'venecia': 'venice',
    'milan': 'milan',
    'roma': 'rome',
    'paris': 'paris',
    'tokio': 'tokyo',
    'seul': 'seoul',
    'pekin': 'beijing',
    'bangkok': 'bangkok',
    'sidney': 'sydney',
}


FALLBACK_AIRPORTS = [
    {'label': 'Madrid (MAD)', 'value': 'MAD', 'keywords': ['madrid', 'espana', 'spain']},
    {'label': 'Barcelona (BCN)', 'value': 'BCN', 'keywords': ['barcelona', 'espana', 'spain']},
    {'label': 'Valencia (VLC)', 'value': 'VLC', 'keywords': ['valencia', 'espana', 'spain']},
    {'label': 'Paris Charles de Gaulle (CDG)', 'value': 'CDG', 'keywords': ['paris', 'francia', 'france']},
    {'label': 'Paris Orly (ORY)', 'value': 'ORY', 'keywords': ['paris', 'francia', 'france']},
    {'label': 'London Heathrow (LHR)', 'value': 'LHR', 'keywords': ['londres', 'london', 'reino unido', 'uk', 'england']},
    {'label': 'Amsterdam Schiphol (AMS)', 'value': 'AMS', 'keywords': ['amsterdam', 'holanda', 'paises bajos', 'netherlands']},
    {'label': 'Frankfurt (FRA)', 'value': 'FRA', 'keywords': ['frankfurt', 'alemania', 'germany']},
    {'label': 'Munich (MUC)', 'value': 'MUC', 'keywords': ['munich', 'munchen', 'alemania', 'germany']},
    {'label': 'Zurich (ZRH)', 'value': 'ZRH', 'keywords': ['zurich', 'suiza', 'switzerland']},
    {'label': 'Vienna (VIE)', 'value': 'VIE', 'keywords': ['viena', 'austria']},
    {'label': 'Prague (PRG)', 'value': 'PRG', 'keywords': ['praga', 'chequia', 'republica checa', 'czech']},
    {'label': 'Istanbul (IST)', 'value': 'IST', 'keywords': ['estambul', 'istanbul', 'turquia', 'turkey']},
    {'label': 'Athens (ATH)', 'value': 'ATH', 'keywords': ['atenas', 'grecia', 'greece']},
    {'label': 'Lisbon (LIS)', 'value': 'LIS', 'keywords': ['lisboa', 'portugal']},
    {'label': 'Rome Fiumicino (FCO)', 'value': 'FCO', 'keywords': ['roma', 'rome', 'italia', 'italy']},
    {'label': 'Milan Malpensa (MXP)', 'value': 'MXP', 'keywords': ['milan', 'italia', 'italy']},
    {'label': 'Bucharest Otopeni (OTP)', 'value': 'OTP', 'keywords': ['bucarest', 'bucharest', 'rumania', 'romania']},
    {'label': 'Warsaw Chopin (WAW)', 'value': 'WAW', 'keywords': ['varsovia', 'warsaw', 'polonia', 'poland']},
    {'label': 'Moscow Sheremetyevo (SVO)', 'value': 'SVO', 'keywords': ['moscu', 'moscow', 'rusia', 'russia']},
    {'label': 'Cairo (CAI)', 'value': 'CAI', 'keywords': ['el cairo', 'cairo', 'egipto', 'egypt']},
    {'label': 'Casablanca (CMN)', 'value': 'CMN', 'keywords': ['casablanca', 'marruecos', 'morocco']},
    {'label': 'Nairobi (NBO)', 'value': 'NBO', 'keywords': ['nairobi', 'kenia', 'kenya']},
    {'label': 'Johannesburg (JNB)', 'value': 'JNB', 'keywords': ['johannesburgo', 'johannesburg', 'sudafrica', 'south africa']},
    {'label': 'Bangkok Suvarnabhumi (BKK)', 'value': 'BKK', 'keywords': ['bangkok', 'tailandia', 'thailand']},
    {'label': 'Singapore Changi (SIN)', 'value': 'SIN', 'keywords': ['singapur', 'singapore']},
    {'label': 'Hong Kong (HKG)', 'value': 'HKG', 'keywords': ['hong kong']},
    {'label': 'Seoul Incheon (ICN)', 'value': 'ICN', 'keywords': ['seul', 'seoul', 'corea del sur', 'south korea']},
    {'label': 'Beijing Capital (PEK)', 'value': 'PEK', 'keywords': ['pekin', 'beijing', 'china']},
    {'label': 'Shanghai Pudong (PVG)', 'value': 'PVG', 'keywords': ['shanghai', 'china']},
    {'label': 'Delhi (DEL)', 'value': 'DEL', 'keywords': ['delhi', 'india']},
    {'label': 'Tokyo Haneda (HND)', 'value': 'HND', 'keywords': ['tokio', 'tokyo', 'japon', 'japan']},
    {'label': 'Osaka Kansai (KIX)', 'value': 'KIX', 'keywords': ['osaka', 'japon', 'japan']},
    {'label': 'Sydney (SYD)', 'value': 'SYD', 'keywords': ['sidney', 'sydney', 'australia']},
    {'label': 'Melbourne (MEL)', 'value': 'MEL', 'keywords': ['melbourne', 'australia']},
    {'label': 'Auckland (AKL)', 'value': 'AKL', 'keywords': ['auckland', 'nueva zelanda', 'new zealand']},
    {'label': 'New York JFK (JFK)', 'value': 'JFK', 'keywords': ['nueva york', 'new york', 'eeuu', 'united states']},
    {'label': 'Newark (EWR)', 'value': 'EWR', 'keywords': ['newark', 'nueva york', 'new york', 'eeuu']},
    {'label': 'Miami (MIA)', 'value': 'MIA', 'keywords': ['miami', 'eeuu', 'united states']},
    {'label': 'Los Angeles (LAX)', 'value': 'LAX', 'keywords': ['los angeles', 'eeuu', 'united states']},
    {'label': 'Chicago O\'Hare (ORD)', 'value': 'ORD', 'keywords': ['chicago', 'eeuu', 'united states']},
    {'label': 'Toronto Pearson (YYZ)', 'value': 'YYZ', 'keywords': ['toronto', 'canada']},
    {'label': 'Montreal (YUL)', 'value': 'YUL', 'keywords': ['montreal', 'canada']},
    {'label': 'Mexico City (MEX)', 'value': 'MEX', 'keywords': ['ciudad de mexico', 'mexico city', 'mexico']},
    {'label': 'Cancun (CUN)', 'value': 'CUN', 'keywords': ['cancun', 'mexico']},
    {'label': 'Bogota (BOG)', 'value': 'BOG', 'keywords': ['bogota', 'colombia']},
    {'label': 'Lima (LIM)', 'value': 'LIM', 'keywords': ['lima', 'peru']},
    {'label': 'Santiago (SCL)', 'value': 'SCL', 'keywords': ['santiago', 'chile']},
    {'label': 'Buenos Aires Ezeiza (EZE)', 'value': 'EZE', 'keywords': ['buenos aires', 'argentina']},
    {'label': 'Sao Paulo Guarulhos (GRU)', 'value': 'GRU', 'keywords': ['sao paulo', 'san pablo', 'brasil', 'brazil']},
    {'label': 'Rio de Janeiro Galeao (GIG)', 'value': 'GIG', 'keywords': ['rio de janeiro', 'brasil', 'brazil']},
    {'label': 'Panama City Tocumen (PTY)', 'value': 'PTY', 'keywords': ['panama', 'panama city']},
    {'label': 'San Jose (SJO)', 'value': 'SJO', 'keywords': ['san jose', 'costa rica']},
    {'label': 'Dubai (DXB)', 'value': 'DXB', 'keywords': ['dubai', 'emiratos', 'uae']},
    {'label': 'Doha Hamad (DOH)', 'value': 'DOH', 'keywords': ['doha', 'catar', 'qatar']},
    {'label': 'Abu Dhabi (AUH)', 'value': 'AUH', 'keywords': ['abu dhabi', 'emiratos', 'uae']},
    {'label': 'Riyadh (RUH)', 'value': 'RUH', 'keywords': ['riad', 'riyadh', 'arabia saudi', 'saudi arabia']},
]


def construir_terminos_busqueda(termino_raw: str) -> list[str]:
    termino = (termino_raw or '').strip().lower()
    termino_norm = normalizar_texto(termino)

    terminos = []
    alias = SPANISH_TO_ENGLISH.get(termino_norm)
    if alias and alias not in terminos:
        terminos.append(alias)

    for t in (termino_norm, termino):
        if t and t not in terminos:
            terminos.append(t)

    palabras = termino_norm.split()
    traducidas = [SPANISH_TO_ENGLISH.get(p, p) for p in palabras]
    compuesto = ' '.join(traducidas).strip()
    if compuesto and compuesto not in terminos:
        terminos.append(compuesto)

    return terminos


def buscar_fallback_es(termino_raw: str, limit: int = 10):
    termino_norm = normalizar_texto(termino_raw)
    if len(termino_norm) < 2:
        return []

    resultados = []
    vistos = set()

    for aeropuerto in FALLBACK_AIRPORTS:
        label_norm = normalizar_texto(aeropuerto['label'])
        keywords_norm = [normalizar_texto(k) for k in aeropuerto.get('keywords', [])]

        if termino_norm in label_norm or any(termino_norm in kw for kw in keywords_norm):
            key = (aeropuerto['label'], aeropuerto['value'])
            if key not in vistos:
                resultados.append({'label': aeropuerto['label'], 'value': aeropuerto['value']})
                vistos.add(key)

    return resultados[:limit]
