<!-- MODAL UNIVERSAL DE RESERVA DE TOURS -->
<div id="modal-reserva-tour" class="modal-overlay" style="display:none;">
    <div class="modal-content-luxe">
        <header class="modal-header-luxe">
            <div class="header-titles">
                <span class="badget-modal">RESERVA PREMIUM</span>
                <h3 id="mrt-titulo">Título del Viaje</h3>
            </div>
            <button class="close-modal-btn" onclick="cerrarModalReserva()">
                <i class="fas fa-times"></i>
            </button>
        </header>

        <div class="modal-body-luxe">
            <div class="tour-summary-mini">
                <img id="mrt-img" src="" alt="Destino">
                <div class="mini-info">
                    <span id="mrt-destino" class="mini-dest">Destino</span>
                    <span id="mrt-precio" class="mini-price">Desde 0€</span>
                </div>
            </div>

            <form id="form-reserva-tour" class="form-luxe-grid">
                <input type="hidden" id="mrt-id" name="tour_id">

                <div class="form-group full">
                    <label>Nombre Completo</label>
                    <input type="text" name="nombre" required placeholder="Tal como aparece en el pasaporte">
                </div>

                <div class="form-group half">
                    <label>Email</label>
                    <input type="email" name="email" required placeholder="tu@email.com">
                </div>

                <div class="form-group half">
                    <label>Teléfono</label>
                    <input type="tel" name="telefono" required placeholder="+34 600 000 000">
                </div>

                <div class="form-group half">
                    <label>Viajeros</label>
                    <input type="number" name="personas" min="1" value="2" required>
                </div>

                <div class="form-group half">
                    <label>Fecha Preferida</label>
                    <input type="text" name="fecha" class="datepicker-input" placeholder="Selecciona fecha">
                </div>

                <div class="form-group full">
                    <label>Observaciones / Necesidades Especiales</label>
                    <textarea name="mensaje" rows="3"
                        placeholder="Alergias, habitación con vistas, celebración especial..."></textarea>
                </div>

                <div class="form-footer">
                    <p class="legal-text">
                        <input type="checkbox" required> Acepto la política de privacidad y condiciones de reserva.
                    </p>
                    <button type="submit" class="btn-reserva-final">
                        SOLICITAR BLOQUEO DE PLAZAS
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Estilos Específicos del Modal Premium */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(8px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-content-luxe {
        background: #fff;
        width: 95%;
        max-width: 600px;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal-header-luxe {
        background: #f8fafc;
        padding: 24px 32px;
        display: flex;
        justify-content: space-between;
        align-items: start;
        border-bottom: 1px solid #e2e8f0;
    }

    .badget-modal {
        font-size: 0.75rem;
        color: #bfa15f;
        font-weight: 700;
        letter-spacing: 1px;
        text-transform: uppercase;
        display: block;
        margin-bottom: 4px;
    }

    #mrt-titulo {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        color: #1e293b;
        margin: 0;
        line-height: 1.2;
    }

    .close-modal-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #94a3b8;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close-modal-btn:hover {
        color: #ef4444;
    }

    .modal-body-luxe {
        padding: 32px;
        background: #fff;
        max-height: 80vh;
        overflow-y: auto;
    }

    .tour-summary-mini {
        display: flex;
        align-items: center;
        gap: 16px;
        background: #f1f5f9;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 24px;
    }

    .tour-summary-mini img {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
    }

    .mini-info {
        display: flex;
        flex-direction: column;
    }

    .mini-dest {
        font-weight: 700;
        color: #334155;
    }

    .mini-price {
        color: #bfa15f;
        font-weight: 600;
    }

    .form-luxe-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group.full {
        grid-column: span 2;
    }

    .form-group.half {
        grid-column: span 1;
    }

    .form-group label {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
    }

    .form-group input,
    .form-group textarea {
        padding: 12px 16px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        border-color: #bfa15f;
        box-shadow: 0 0 0 3px rgba(191, 161, 95, 0.1);
        outline: none;
    }

    .btn-reserva-final {
        width: 100%;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        color: #fff;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }

    .btn-reserva-final:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

<script>
    function abrirModalReserva(id, titulo, precio, img) {
        document.getElementById('mrt-id').value = id;
        document.getElementById('mrt-titulo').textContent = titulo;
        document.getElementById('mrt-precio').textContent = "Aprox. " + precio + "€";
        document.getElementById('mrt-img').src = img;

        document.getElementById('modal-reserva-tour').style.display = 'flex';

        // Init datepicker if not init
        if (window.flatpickr) {
            flatpickr(".datepicker-input", {
                minDate: "today",
                dateFormat: "d/m/Y",
                locale: "es"
            });
        }
    }

    function cerrarModalReserva() {
        document.getElementById('modal-reserva-tour').style.display = 'none';
    }

    document.getElementById('form-reserva-tour').addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        btn.disabled = true;

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/reservar-tour', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert('¡Solicitud enviada con éxito! Revisa tu correo.');
                cerrarModalReserva();
                this.reset();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
</script>